Инструкция по установке программного обеспечения компелеса грозопеленгации.
==========

## Общая характеристика 
Программное обеспечение (далее ПО) комплекса грозопеленгации состоит из двух независимых частей:
1. Скрипт сбора данных с устройства LD-250. Принимает данные с грозопеленгатора, производит пересчёт радиальных координат в пространственные и сохраняет данные в базе данных и текстовых файлах. Скрипт написан на языке Python, сервер базы данных - PostgreSQL.
2. Скрипт обработки и отображения данных, считывает данные грозопеленгации из базы данных и отображает их на геоинформационной основе в реальном времени либо в ретроспективе. Скрипт написан на PHP/JavaScript и функционирует на базе веб-сервера Apache. Данная версия ПО рассчитана на одновременную работу с двумя серверами база данных одновременно.

Для доступа к данным может быть использован любой интернет-браузер, поддерживающий выполнение макросов JavaScript, установленный на компьютере пользователя.


**Ниже рассмотрена последовательность действий по предварительной установке ПО. Все действия описаны для операционной системы (далее ОС) _CentOS 7_ с графической оболочкой _GNOME_ (установка и настройка ОС не рассатривается в данном руководстве). Команды выполняются в терминале, если не указано иное. Системный пользователь boltek c паролем boltek уже создан в системе.**



## 1. Предварительная настройка ОС и стандартного ПО.

На компьютерах реализован автоматический вход в систему под пользователем boltek.

Запустить терминал (в GNOME “Терминал” в меню). Создать директорию distrib:

	$ mkdir /home/boltek/distrib

Войти под пользователем _root (пароль = fnvjcathf):_

	$ su -

Желательно обновить систему:

	$ yum update -y

В случае возникновения ошибки обновления пакета qt-qwebkit удалить его командой 

	$ yum remove qt-qwebkit

затем повторить команду обновления системы.

Установить репозиторий _EPEL:_

	$ yum -y install epel-release

Установить сервер баз данных _PostgreSQL_,web-сервер _Apache_, интерпретатор _PHP_, необходимые библиотеки и модули:

	$ yum install postgresql-server postgresql-contrib php php-pgsql php-gd php-mbstring php-mcrypt php-pdo php-pear php-process php-xml python-psycopg2 pyserial httpd screen wget -y

Инициализировать базу данных:

	$ postgresql-setup initdb

Настроить _Firewall :_

	$ firewall-cmd --permanent --add-port=5432/tcp
	$ firewall-cmd --permanent --add-port=80/tcp
	$ firewall-cmd --reload

Установить параметры SELinux, после чего перезапустить компьютер:

	$ setsebool -P httpd_can_network_connect_db 1
	$ reboot

Войти в систему под пользователем _boltek_

Войти под пользователем _root_ (в терминале):

	$ su -

Запустить сервер _PostgreSQL:_

	$ systemctl enable postgresql
	$ systemctl start postgresql

Войти под пользователем postgres:

	$ su - postgres

Подключиться к серверу _PostgreSQL:_

	$ psql

//----в _psql_ ----------------------------------------

Установить пароль пользователя postgres:

	# \password postgres

На запрос ввести пароль, потом подтвердить.

Выйти из оболочки psql:

	# \q

//----- _psql_ ----------------------------------------

Создать пользователя _boltek_, который будет иметь доступ к базе:

	$ createuser boltek		

Создать базу данных _groza:_

	$ createdb groza

Подключиться к серверу _PostgreSQL _для установки пароля пользователя _boltek_ и предоставления ему доступа к базе _groza:_

	$ psql

//----в _psql_ ----------------------------------------

Соответственно подставить вместо _password_ необходимый пароль:

	# alter user boltek with encrypted password '_password_';
	# grant all privileges on database groza to boltek;

Выйти из оболочки psql:

	# \q

//----- _psql_ ----------------------------------------

Далее, необходимо отредактировать файлы конфигурации _PostgreSQL_ в любом текстовом редакторе, например “_vi”_ или “_nano”_ (работа с редакторами текста здесь не рассматривается). Отдельно следует отметить, что права на данные файлы, после окончания редактирования, должны принадлежать пользователю _postgres_, иначе сервер работать не будет. Это стоит учесть, если файлы редактировались от имени другого пользователя.

В файле _/var/lib/pgsql/data/postgresql.conf_ найти строчку "listen_addresses" и прописать IP-адрес другого компьютера сети грозопеленгации. То есть, если данный файл находится на компьютере установленном в Рыболово, то необходимо прописать адрес компьютера в Парабели:

//--------в _/var/lib/pgsql/data/postgresql.conf_ --------

	#------------------------------------------------------------------------------ \
	# CONNECTIONS AND AUTHENTICATION \
	#------------------------------------------------------------------------------ \
	\
	# - Connection Settings - \
	\
	#listen_addresses = 'localhost'			# what IP address(es) to listen on; \
	listen_addresses = 'localhost, 192.168.1.1'		# comma-separated list of addresses; \
								# defaults to 'localhost'; use '*' for all \
								# (change requires restart) \
	#port = 5432	 \
	port = 5432						# (change requires restart) \
//--------- _/var/lib/pgsql/data/postgresql.conf_ --------

В файле _/var/lib/pgsql/data/pg_hba.conf_ необходимо задать соответствующие правила аутентификации для локального и удалённого подключения к базе. Соответственно, IP-адрес удалённого хоста должен соответствовать адресу из _/var/lib/pgsql/data/postgresql.conf_. Пример приведён ниже:

//--------в _/var/lib/pgsql/data/pg_hba.conf_ ------------

	# IPv4 local connections: \
	host	all           	all            	127.0.0.1/32      	password \
	host	all		all		192.168.1.1		md5

//---------/var/lib/pgsql/data/pg_hba.conf----------------

После внесения изменений необходимо перезагрузить сервер _PostgreSQL_ (потребуется ввести пароль _root_)

	$ systemctl restart postgresql

Подключиться к базе данных _groza_

	$ psql -d groza

//----в _groza_ ----------------------------------------

Создать таблицы _ribolovo_ и_ parabel_

	# CREATE TABLE IF NOT EXISTS ribolovo (time_date TIMESTAMP PRIMARY KEY NOT NULL, latitude FLOAT NOT NULL, longitude FLOAT NOT NULL, distance_corr INT, distance INT, azimuth REAL);
	# CREATE TABLE IF NOT EXISTS parabel (time_date TIMESTAMP PRIMARY KEY NOT NULL, latitude FLOAT NOT NULL, longitude FLOAT NOT NULL, distance_corr INT, distance INT, azimuth REAL);

Предоставить доступ к таблицам пользователю boltek

	# GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO boltek;

Выйти из оболочки psql

	# \q

//----- _groza_ ----------------------------------------

Под пользователем _root:_

Дать права на запись в директорию _/var/www/html_ для всех пользователей:

	$ chmod a+wx /var/www/html/

В файле _ /etc/httpd/conf/httpd.conf_ , в секции "&lt;IfModule mime_module>" при помощи текстового редактора добавить строчку:

AddType application/x-httpd .php

Запустить сервер Apache:

	$ systemctl enable httpd
	$ systemctl start httpd

## 2. Установка и настройка скрипта сбора данных LD-250

Действия выполняются под пользователем _boltek в терминале:_

Создать каталог _/home/boltek/distrib_

	$ mkdir _/home/boltek/distrib_

Скачать скрипт и данные предыдущих лет грозопеленгации в каталог_ /home/boltek/distrib:_

	$ cd ~/distrib
	$ wget https://yadi.sk/d/SjqkMGKm3JrmRH -O script.tar.bz2
	$ wget https://yadi.sk/d/HHYTObqp3JrmVZ -O old_time_data.tar.bz2

В случае, если файл не скачивается, необходимо повторять попытки до успешного завершения.

Также можно загрузить ПО и данные, воспользовавшись браузером, по ссылкам (Yandex Disk):

[https://yadi.sk/d/SjqkMGKm3JrmRH](https://yadi.sk/d/SjqkMGKm3JrmRH)

https://yadi.sk/d/HHYTObqp3JrmVZ  

Распаковать содержимое архивов в директорию _/home/boltek/boltek:_

	$ cd ~/boltek
	$ tar -vxf ~/distrib/script.tar.bz2
	$ tar -vxf ~/distrib/old_time_data.tar.bz2

Скопировать данные грозопеленгации предыдущих лет в базу данных _groza:_

Войти в базу данных командой:

$ psql -U boltek -d groza

//----в _groza_ ----------------------------------------

Выполнить команды:

	\copy public.parabel (time_date, latitude, longitude, distance_corr, distance, azimuth) FROM '/home/boltek/boltek/old_time_data/parabel_data_old.csv' DELIMITER ',' CSV;
	\copy public.ribolovo (time_date, latitude, longitude, distance_corr, distance, azimuth) FROM '/home/boltek/boltek/old_time_data/ribolovo_data_old.csv' DELIMITER ',' CSV;

	При необходимости можно проверить наличие записей в таблице командой:

	SELECT * FROM ribolovo;
	SELECT * FROM parabel;
	Выйти из базы данных командой:
	\q

//----- _groza_ ----------------------------------------

Скопировать ярлык запуска на рабочий стол и в директорию автозапуска. В зависимости от конфигурации системы, вместо директории “Рабочий стол” может быть директория “Desktop”. На это следует обратить внимание, выполняя нижеприведенные команды.

	$ cp /home/boltek/boltek/boltek.desktop /home/boltek/Рабочий\ стол/ 
	$ cp /home/boltek/boltek/boltek.desktop /home/boltek/.config/autostart/

Сделать ярлыки исполняемыми

	$ chmod +x /home/boltek/Рабочий\ стол/boltek.desktop
	$ chmod +x /home/boltek/.config/autostart/boltek.desktop

Отредактировать файл настроек _/home/boltek/boltek/settings.ini_, в любом текстовом редакторе. Основные настройки с комментариями приведены ниже:

//-----------------в _settings.ini_ --------------------

	Folder = /home/boltek/boltek/data/	; Директория, в которую будут сохраняться данные в текстовом виде. Менять не рекомендуется
	Interval = 30						; Интервал записи в файл. Менять не рекомендуется
	Name = Ribolovo						; Название базы данных. _Ribolovo_  либо  _Parabel_ соответственно, в зависимости от места установки конкретного пеленгатора.
	Lat = 56.510155						; Широта установки антенны пеленгатора (Ribolovo = 56.510155; Parabel = 58.692838) 
	Lon = 84.522649						; Долгота установки антенны пеленгатора (Ribolovo = 84.522649; Parabel = 81.486368)
	Com = /dev/ttyUSB					; Физическое имя порта, куда подключен грозопеленгатор. Не Менять!
	Настройки прибора. Подробнее см. руководство пользователя.
	SQ = 7								; Шумоподавление от 0 до 15. 
	CA = 250							; Сигнализация приближающейся грозы от 0 до 255
	SA = 100							; Сигнализация сильной грозы от 0 до 999
	NB = 0								; звуковая сигнализация помех 0 - отключена, 1 - включена
	MS = 10								; Минимальная скорость при мобильной установке. В данном случае не имеет значения
	Work = True							; Флаг. Пока True, скрипт функционирует. False - Завершает работу
	DBname = groza						; Название базы данных. Не менять.
	DBuser = boltek						; Имя пользователя базы данных
	DBpass = boltek						; Пароль, соответственно
	DBhost = < IP адрес локального компьютера >	; Необходимо указать адрес базы данных, который слушает сама база данных (например, для Рыболово это 10.70.40.123)

//--------------- _settings.ini_ --------------------------

Запустить скрипт сбора данных LD250 двойным щелчком мыши на ярлыке _boltek_, созданном ранее на рабочем столе. При удалённом управлении компьютерами системы грозопеленгации, ручной запуск скрипта выполняется командой:

	$ sh /home/boltek/boltek/boltek.sh

_После успешного запуска (см рис.1) нажать сочетание клавиш &lt;Ctrl+a>, затем &lt;d>, что переведёт работу скрипта в фоновой режим в виртуальной консоли screen_

При этом, прибор LD-250 должен быть подключен к одному из USB портов компьютера, питание включено. Скриншот работающего скрипта приведён на рисунке 1. При регистрации событий на экран выводятся данные, принятые из грозопелегатора. При дальнейшей презагрузке компьютера, скрипт стартует автоматически.

При удалённом управлении, проверить работу скрипта можно подключившись к соответствующему процессу утилиты _screen :_

	$ screen -x ld

После проверки, отключиться от виртуальной консоли нажав сочетание клавиш  < Ctrl+a >, затем < d >. 

![Рисунок 1.](images/%D0%A0%D0%B8%D1%81_1.jpg "Рисунок 1")

Рисунок 1.

## 3. Установка и настройка скрипта обработки и отображения данных

Установку данного скрипта можно выполнить только на одном из компьютеров.

Действия выполняются под пользователем _boltek в терминале_

Скачать скрипт и тайлы карт в каталог_ /home/bolte/distrib._ Загрузка файла Tiles.tar.bz2 может занять длительное время, поскольку он имеет большой размер.

	$ cd ~/distrib
	$ wget “https://yadi.sk/d/SqPVltJ23JrmKm” -O html.tar.bz2
	$ wget “https://yadi.sk/d/f9vOskys3Jpu8i” -O Tiles.tar.bz2

Также можно загрузить данное ПО и данные, воспользовавшись браузером, по ссылкам (Yandex Disk):

	https://yadi.sk/d/SqPVltJ23JrmKm
	https://yadi.sk/d/f9vOskys3Jpu8i  

Распаковать содержимое архивов в директорию _/var/www/html/_

	$ cd /var/www/html/
	$ tar -vxf /home/boltek/distrib/html.tar.bz2
	$ tar -vxf /home/boltek//distrib/Tiles.tar.bz2

Отредактировать файл настроек _/var/www/html/config.ini_. Пример с описанием настроек приведён ниже:

//----------------в _config.ini_ ------------------------

	[LeafLet]
	tails = "[http://192.168.1.1/Tiles/{z}/{x}/{y}.png](http://217.71.132.175/Tiles/{z}/{x}/{y}.png)"
	; адрес сервера с тайлами карт. IP адрес в строке должен совпадать с IP адресом компьютера


	minZoom		= 6						; минимальный зум карты
	maxZoom		= 14		  			; максимальный зум карты
	; в данном случае рендер карты выполнен от 6 до 14 масштаба, поэтому эти параметры менять не рекомендуется

	latitude	= 58.6897				; стартовая широта
	longitude	= 81.5381				; стартовая долгота
	zoom 		= 7						; стартовый зум
	; Место центра и масштаб, в котором карта будет отображаться при старте браузера. В данном случае заданы примерные координаты центра Томской области

//----------------- _config.ini_ -----------------------

Отредактировать файл настроек базы данных 1 _/var/www/html/bd1.ini_. 
Пример с описанием настроек приведён ниже:

//----------------в _bd1.ini_ --------------------------

	[BD_PostgreSQL] \
	host		= "localhost"	; адрес хоста с базой данных 1. Соответственно здесь адрес локального компьютера
	base		= "groza"		; имя базы данных
	user		= "boltek"		; имя пользователя базы данных
	password	= "boltek"		; пароль
	table		= "ribolovo"	; таблица, содержащая данные по грозовым событиям
	location	= "Рыболово"	; наименование точки установки грозопеленгатора. Это имя будет отображаться при просмотре.

//----------------- _bd1.ini_ --------------------------


Отредактировать файл настроек базы данных 2 _/var/www/html/bd2.ini_ :

//----------------в _bd2.ini_ --------------------------

	[BD_PostgreSQL] \
	host		= "192.168.1.2"	; адрес хоста с базой данных 2. Соответственно здесь адрес удалённого (второго) компьютера.
	base		= "groza"		; имя базы данных
	user		= "boltek"		; имя пользователя базы данных
	password	= "boltek"		; пароль
	table		= "parabel"		; таблица, содержащая данные по грозовым событиям
	location	= "Парабель"	; наименование точки установки грозопеленгатора. Это имя будет отображаться при просмотре.

//----------------- _bd2.ini_ --------------------------

Для использования программы зайти с помощью браузера по соответствующему IP адресу. Отобразится страница, представленная на рисунке 2. Для проверки автоматического старта ПО, рекомендуется перезагрузить компьютер и убедиться, что скрипт сбора данных запустился, а система отображения функционирует.

![Рисунок 2](images/%D0%A0%D0%B8%D1%81_2.jpg "Рисунок 2")

Рисунок 2.

## 4. Руководство по просмотру данных грозопеленгации

Войти при помощи браузера, со включенной поддержкой JavaScript, по IP адресу компьютера, с установленной системой отображения данных. Будет выведена страница представленная на рисунке 2.


В Левом верхнем углу страницы расположены кнопки изменения масштаба отображения данных. Рисунок 3. Масштаб также можно изменять вращением колеса мыши. Перемещение карты осуществляется мышью, с зажатой левой кнопкой.

![Рисунок 3](images/%D0%A0%D0%B8%D1%81_3.jpg "Рисунок 3")

Рисунок 3.

В правом углу страницы находятся строка статуса и кнопки изменения режимов работы. В строке статуса отображается режим работы ПО а также доступность данных от пеленгаторов. Пример отображения в режиме реального времени показан на рисунке 4.  Интервал отображения 30 минут, зарегистрировано 0 грозовых разрядов. Доступны данные всех грозопеленгаторов. Если какая-то из баз данных недоступна, соответствующие название не отображаются в строке статуса. Недоступность данных одного или всех компьютеров может свидетельствовать о наличии неисправности. Например, отсутствие связи между компьютерами сети грозопеленгации, отключении компьютера в связи с перебоями электропитания, и так далее. 

![Рисунок 4](images/%D0%A0%D0%B8%D1%81_4.jpg "Рисунок 4")

Рисунок 4.

Строка статуса в режиме отображения ретроспективных данных  рисунок 5. Просмотр данных за 06.06.2017 года, с 2.00 до 23.00 часов. Отображено 969 событий.

![Рисунок 5](images/%D0%A0%D0%B8%D1%81_5.jpg "Рисунок 5")

Рисунок 5. 

Для переключения ПО в режим реального времени следует нажать на кнопку с изображением часов, и выбрать необходимый интервал времени. Рисунок 6. Этот интервал означает на сколько часов или минут вглубь от настоящего момента, данные получаемые в реальном времени, будут отображены на геоинформационной основе. 

![Рисунок 6](images/%D0%A0%D0%B8%D1%81_6.jpg "Рисунок 6")

Рисунок 6.

При выборе интервала времени следует учитывать, что большее значение увеличивает количество данных отображаемых на экране. Большее количество данных требует соответственно больших ресурсов компьютера, на котором ведётся просмотр. При большой интенсивности регистрируемой грозовой деятельности, большой интервал времени может приводить к весьма существенной нагрузке на процессор компьютера и загрузке его памяти.

Отображение грозовых ударов на карте в реальном времени реализовано в виде окружностей синего цвета. Чем дальше отстоит событие от настоящего времени, тем меньше диаметр окружности и тусклее её цвет. Новые грозовые события, на короткое время отображаются красной окружностью. Рисунок 7.

![Рисунок 7](images/%D0%A0%D0%B8%D1%81_7.jpg "Рисунок 7")

Рисунок 7.

При выборе какой-либо окружности курсором мыши (навести и нажать), будет выведено сообщение с информацией о событии. Рисунок 8. 

![Рисунок 8](images/%D0%A0%D0%B8%D1%81_8.jpg "Рисунок 8")

Рисунок 8.

Для просмотра ретроспективных данных следует нажать на кнопку с изображением календаря. Рисунок 9. В открывшейся вкладке выбрать дату и интервал времени для просмотра. В нижней части вкладки отобразится количество событий зарегистрированных за этот период. Нажать на на строку “Загрузить (n) событий” для их показа на геооснове.

![Рисунок 9](images/%D0%A0%D0%B8%D1%81_9.jpg "Рисунок 9")

Рисунок 9.

Ретроспективные данные отображаются одинаковыми окружностями, выбрав любую из которых можно получить сведения о событии. Время дату и название пеленгатора. Рисунок 10. 

![Рисунок 10](images/%D0%A0%D0%B8%D1%81_10.jpg "Рисунок 10")

Рисунок 10.

Следует также учитывать вышеизложенный факт, что большое число событий может создавать большую нагрузку на компьютер, на котором производится просмотр данных.

## 5. Примечания

Автологин в GNOME:

//--------------в _/etc/gdm/custom.conf_ ---------------

	[daemon]
	AutomaticLoginEnable=true
	AutomaticLogin=alexandr

//---------------- _/etc/gdm/custom.conf_ --------------

Добавить пользователя boltek в группу dialout:

	# sudo usermod -aG dialout boltek